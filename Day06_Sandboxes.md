# Day 06[Sandboxes] : If I can't find a nice malware to use, I'm not going.

## Story :
Mayor Malware has made a plan to destroy SOC-mas and scare all the SOC teams. Even when Glitch and McSkidy found him out, he was confident enough that they cannot stop him and to test his malware he uses a sandbox. Let us check for shortcomings of the malware(if there are any).

## Learning objectives :
- Analyze malware behaviour using sandbox tools.
- Explore how to use YARA rules to detect malicious patterns.
- Learn about various malware evasion techniques.
- Implement an evasion technique to bypass YARA rule detection.

## Abbreviations and Applications :
- [SOC](https://www.ibm.com/topics/security-operations-center) : Security Operations Center
- [YARA](https://yara.readthedocs.io/en/stable/index.html) : YARA is a tool aimed at (but not limited to) helping malware researchers to identify and classify malware samples.
- [Floss](https://github.com/mandiant/flare-floss) : A tool to extract obfuscated strings from malware binaries.

## Now for the key process points: 
- Sandbox Detection Technique: Malware checks for the presence of the directory C:\ProgramFiles by querying the Registry path HKLM\\Software\\Microsoft\\Windows\\CurrentVersion.
- Purpose of Sandbox Detection: Malware avoids executing malicious activities if it detects a sandbox environment.
- Registry Query Implementation: The registry check is implemented in C programming language using the reg.exe command.
- Malware Functionality: The malware checks the registry for a specific directory path (ProgramFilesDir) to determine if it’s running in a virtualized environment.
- YARA Rule Testing: Mayor Malware tests a YARA rule that detects registry access to ensure it can’t be detected by YARA.
- YARA Rule Details: The YARA rule (SANDBOXDETECTED) looks for the string “Software\\Microsoft\\Windows\\CurrentVersion\” /v ProgramFilesDir” in the registry.
- EDR Functionality: The EDR monitors Sysmon events and alerts on registry key queries.
- Malware Detection: Yara can detect the malware’s evasion techniques.Obfuscation Implementation: Obfuscation is introduced to make the malware stealthier.
- Registry Query Execution: Executes a registry query using PowerShell and encoded command.
- Command Execution Result: Checks the result of the system command to determine if the registry query was successful.
- Obfuscation Tool: Floss, a tool similar to strings, can extract obfuscated strings from malware binaries.
- Malware Analysis Tool: Floss.exe is used to scan for hardcoded strings in a malware sample.YARA Rule Application: YARA rules can be used to analyze Sysmon logs for malware artifacts, specifically looking for process creation events.
- Sysmon Log Analysis: Sysmon logs, generated by Microsoft’s Sysinternals suite, provide detailed information on system activity, including process creation, network connections, and file changes.
- EDR Log File Content Check: Use the command `get-content C:\Tools\YaraMatches.txt` to check the content of the EDR log file.
- Event Record ID Retrieval: Note down the Event Record ID from the EDR log file output for creating a custom filter in Windows Event Viewer.
- Windows Event Viewer Navigation: Navigate to `Applications and Services Logs -> Microsoft -> Windows -> Sysmon -> Operational` in Windows Event Viewer.
- Event Data Retrieval: Navigate to XML, enable manual query editing, and input the filter with the specific EventRecordID to retrieve the malware-related event.
- Event Details: The event details, including ParentImage, ParentProcessId, ProcessId, User, CommandLine, and UtcTime, provide valuable information for malware analysis and threat hunting.
- Malware Identification: The ParentImage key reveals the parent process (malware location) that spawned the cmd.exe process for registry checks.

> ## Questions and Hints :
1. What is the flag displayed in the popup window after the EDR detects the malware?
  - Hint: Pretty Easy to find as the process on how to find it exactly is given in the room itself.
  - ![Q1_text](/Screenshots/D6Q1.png)
  - Ans : THM{GlitchWasHere}
2. What is the flag found in the malstrings.txt document after running floss.exe, and opening the file in a text editor?
  - Hint: Also given directly in the room. Just run the `floss` tool and
  - ![Q2_help](/Screenshots/D6Q1.png)
  - Ans : THM{HiddenClue}